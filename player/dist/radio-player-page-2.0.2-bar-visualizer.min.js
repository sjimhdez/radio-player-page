const r={BAR_COUNT:72,BAR_COLOR:"rgba(255, 255, 255, 0.1)",SMOOTHING_FACTOR:.15,BAR_SPACING:2,UPDATE_INTERVAL_MS:50,MAX_AMPLITUDE:255,PEAK_DURATION_MS:4e3,PEAK_COLOR:"rgba(19, 181, 210, 0.78)",PEAK_LINE_WIDTH:2},p=new WeakMap;function u(t,n,a){return t.width=n,t.height=a,{smoothedHeights:new Array(r.BAR_COUNT).fill(0),targetHeights:new Array(r.BAR_COUNT).fill(0),previousHeights:new Array(r.BAR_COUNT).fill(0),peaks:[],canvasWidth:n,canvasHeight:a,lastUpdateTime:Date.now()}}function g(t,n,a){let s=0;const i=a-n;for(let e=n;e<a;e++)s+=t[e];return s/i}function m(t,n){return Math.max(0,Math.min(t,r.MAX_AMPLITUDE))/r.MAX_AMPLITUDE*n}function P(t,n){const a=Math.floor(t.length/r.BAR_COUNT),s=[];for(let i=0;i<r.BAR_COUNT;i++){const e=i*a,l=Math.min(e+a,t.length),A=g(t,e,l);s[i]=m(A,n)}return s}function I(t,n){return t+(n-t)*r.SMOOTHING_FACTOR}function O(t,n){const a=r.BAR_SPACING*(n-1),i=(t-a)/n,e=[];for(let l=0;l<n;l++)e[l]=l*(i+r.BAR_SPACING);return{barWidth:i,barPositions:e}}function R(t,n,a,s,i){t.clearRect(n,0,a,i),t.fillStyle=r.BAR_COLOR,t.fillRect(n,i-s,a,s)}function k(t,n,a){const s=a-n.peakHeight;t.strokeStyle=r.PEAK_COLOR,t.lineWidth=r.PEAK_LINE_WIDTH,t.beginPath(),t.moveTo(n.x,s),t.lineTo(n.x+n.barWidth,s),t.stroke()}function N(t,n,a,s,i,e){const l=[];for(let A=0;A<t.length;A++)if(n[A]>t[A]&&n[A]>5){const c=e.find(d=>d.barIndex===A);(!c||n[A]>c.peakHeight)&&l.push({barIndex:A,peakHeight:n[A],timestamp:i,x:a[A],barWidth:s})}return l}function U(t,n){return t.filter(a=>n-a.timestamp<r.PEAK_DURATION_MS)}const M=(t,n,a,s,i)=>{let e=p.get(a);(!e||e.canvasWidth!==s||e.canvasHeight!==i)&&(e=u(a,s,i),p.set(a,e));const l=Date.now();l-e.lastUpdateTime>=r.UPDATE_INTERVAL_MS&&(e.targetHeights=P(n,i),e.lastUpdateTime=l);const c=r.BAR_COUNT,{barWidth:d,barPositions:f}=O(s,c);e.peaks=U(e.peaks,l);for(let o=0;o<c;o++)e.smoothedHeights[o]=I(e.smoothedHeights[o],e.targetHeights[o]),R(t,f[o],d,e.smoothedHeights[o],i);const T=N(e.smoothedHeights,e.previousHeights,f,d,l,e.peaks);for(const o of T){const h=e.peaks.findIndex(_=>_.barIndex===o.barIndex);h>=0?e.peaks[h]=o:e.peaks.push(o)}e.previousHeights=[...e.smoothedHeights];for(const o of e.peaks)o.x=f[o.barIndex],o.barWidth=d,k(t,o,i)};export{M as barVisualizer};
